<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>go/robo-design</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
/* go/robo-design - Styles */

:root {
  /* Colors */
  --color-primary: #0751CF;
  --color-primary-hover: #0642A8;
  --color-text: #4C5461;
  --color-text-muted: #9CA3AF;
  --color-background: #FAF9F7;
  --color-surface: #FFFFFF;
  --color-border: #E5E7EB;
  --color-border-light: #F3F4F6;

  /* Spacing */
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 24px;
  --space-6: 32px;

  /* Typography */
  --font-heading: 'Lora', Georgia, serif;
  --font-body: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --font-mono: 'SF Mono', Monaco, 'Cascadia Code', Consolas, monospace;

  /* Layout */
  --header-height: 48px;
  --sidebar-width: 220px;
  --chat-width: 320px;

  /* Transitions */
  --transition-fast: 0.1s ease;
  --transition-base: 0.2s ease;
}

/* Reset */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: var(--font-body);
  font-size: 14px;
  color: var(--color-text);
  background: var(--color-background);
  line-height: 1.5;
  overflow: hidden;
}

/* App Layout */
#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* Header */
.header {
  height: var(--header-height);
  background: var(--color-surface);
  border-bottom: 1px solid var(--color-border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 var(--space-4);
  flex-shrink: 0;
}

.header-left {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.header-left h1 {
  font-family: var(--font-heading);
  font-size: 18px;
  font-weight: 600;
  color: var(--color-text);
}

.header-right {
  display: flex;
  align-items: center;
  gap: var(--space-1);
}

/* Main Content */
.main {
  flex: 1;
  display: flex;
  overflow: hidden;
}

/* Sidebar */
.sidebar {
  width: var(--sidebar-width);
  min-width: 150px;
  max-width: 350px;
  background: var(--color-surface);
  border-right: 1px solid var(--color-border);
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-3) var(--space-3) 0;
}

.sidebar-header h2 {
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--color-text-muted);
}

.sidebar-search {
  padding: var(--space-3);
}

.sidebar-search input {
  width: 100%;
  height: 32px;
  padding: 0 var(--space-3);
  border: 1px solid var(--color-border);
  border-radius: 6px;
  font-size: 13px;
  background: var(--color-background);
}

.sidebar-search input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(7, 81, 207, 0.15);
}

.theme-list {
  flex: 1;
  overflow-y: auto;
  padding: 0 var(--space-2);
}

.theme-item {
  display: block;
  width: 100%;
  padding: var(--space-2) var(--space-3);
  border: none;
  background: transparent;
  text-align: left;
  border-radius: 6px;
  cursor: pointer;
  transition: background var(--transition-fast);
}

.theme-item:hover {
  background: var(--color-border-light);
}

.theme-item.active {
  background: var(--color-primary);
  color: white;
}

.theme-item-name {
  font-weight: 500;
  font-size: 13px;
}

.theme-item-desc {
  font-size: 12px;
  color: var(--color-text-muted);
  margin-top: 2px;
}

.theme-item.active .theme-item-desc {
  color: rgba(255, 255, 255, 0.8);
}

/* Resize Handle */
.resize-handle {
  width: 4px;
  cursor: col-resize;
  background: transparent;
  transition: background var(--transition-fast);
}

.resize-handle:hover,
.resize-handle.active {
  background: var(--color-primary);
}

.resize-handle.horizontal {
  width: 100%;
  height: 4px;
  cursor: row-resize;
}

/* Center Panel */
.center-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 400px;
  overflow: hidden;
}

/* Preview Tabs */
.tab {
  padding: var(--space-2) var(--space-3);
  border: none;
  background: transparent;
  font-size: 13px;
  font-weight: 500;
  color: var(--color-text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  margin-bottom: -1px;
  transition: all var(--transition-fast);
}

.tab:hover {
  color: var(--color-text);
}

.tab.active {
  color: var(--color-primary);
  border-bottom-color: var(--color-primary);
}

/* Preview Panel */
.preview-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--color-background);
}

.preview-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-2) var(--space-3);
  background: var(--color-surface);
  border-bottom: 1px solid var(--color-border);
}

.preview-tabs {
  display: flex;
  gap: var(--space-1);
}

.viewport-buttons {
  display: flex;
  gap: var(--space-1);
}

.preview-frame-wrapper {
  flex: 1;
  padding: var(--space-4);
  display: flex;
  justify-content: center;
  overflow: auto;
}

#preview-frame {
  width: 100%;
  height: 100%;
  border: 1px solid var(--color-border);
  border-radius: 8px;
  background: white;
}

/* Chat Panel */
.chat-panel {
  width: var(--chat-width);
  min-width: 250px;
  max-width: 500px;
  background: var(--color-surface);
  border-left: 1px solid var(--color-border);
  display: flex;
  flex-direction: column;
}

.chat-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-3) var(--space-3);
  border-bottom: 1px solid var(--color-border);
}

.chat-header h2 {
  font-size: 14px;
  font-weight: 600;
}

.chat-actions {
  display: flex;
  gap: var(--space-1);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: var(--space-3);
}

.chat-empty {
  text-align: center;
  padding: var(--space-6) var(--space-4);
  color: var(--color-text-muted);
}

.chat-empty p:first-child {
  font-weight: 500;
  color: var(--color-text);
}

.chat-message {
  display: flex;
  gap: var(--space-3);
  margin-bottom: var(--space-4);
}

.chat-message.user {
  flex-direction: row-reverse;
}

.chat-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--color-border-light);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.chat-message.user .chat-avatar {
  background: var(--color-primary);
  color: white;
}

.chat-content {
  flex: 1;
  min-width: 0;
}

.chat-bubble {
  display: inline-block;
  padding: var(--space-2) var(--space-3);
  border-radius: 12px;
  background: var(--color-border-light);
  font-size: 13px;
  max-width: 100%;
  word-wrap: break-word;
}

.chat-message.user .chat-bubble {
  background: var(--color-primary);
  color: white;
}

.chat-image {
  max-width: 200px;
  border-radius: 8px;
  margin-top: var(--space-2);
}

.suggestion-card {
  margin-top: var(--space-2);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  overflow: hidden;
}

.suggestion-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-1) var(--space-2);
  background: var(--color-border-light);
  font-size: 11px;
  font-family: var(--font-mono);
}

.suggestion-actions {
  display: flex;
  gap: var(--space-1);
}

.suggestion-code {
  padding: var(--space-2);
  background: #1e1e1e;
  color: #d4d4d4;
  font-size: 11px;
  font-family: var(--font-mono);
  overflow-x: auto;
  max-height: 150px;
  white-space: pre;
}

.chat-input-area {
  padding: var(--space-3);
  border-top: 1px solid var(--color-border);
}

.attachments {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
  margin-bottom: var(--space-2);
}

.attachments:empty {
  display: none;
}

.attachment {
  position: relative;
}

.attachment img {
  width: 48px;
  height: 48px;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid var(--color-border);
}

.attachment-remove {
  position: absolute;
  top: -6px;
  right: -6px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #EF4444;
  color: white;
  border: none;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chat-input-wrapper {
  position: relative;
  margin-bottom: var(--space-2);
}

#chat-input {
  width: 100%;
  padding: var(--space-2) var(--space-3);
  padding-right: 70px;
  border: 1px solid var(--color-border);
  border-radius: 8px;
  font-size: 13px;
  font-family: inherit;
  resize: none;
  min-height: 80px;
}

#chat-input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(7, 81, 207, 0.15);
}

.chat-input-actions {
  position: absolute;
  bottom: var(--space-2);
  right: var(--space-2);
  display: flex;
  gap: var(--space-1);
}

#send-btn {
  width: 100%;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-2);
  padding: var(--space-2) var(--space-4);
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.btn-primary {
  background: var(--color-primary);
  color: white;
}

.btn-primary:hover {
  background: var(--color-primary-hover);
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-secondary {
  background: transparent;
  color: var(--color-text);
  border: 1px solid var(--color-border);
}

.btn-secondary:hover {
  background: var(--color-border-light);
}

.btn-icon {
  width: 32px;
  height: 32px;
  padding: 0;
  background: transparent;
  color: var(--color-text-muted);
  border: none;
}

.btn-icon:hover {
  color: var(--color-text);
  background: var(--color-border-light);
}

.btn-icon.active {
  color: var(--color-primary);
}

.btn-sm {
  padding: var(--space-1) var(--space-2);
  font-size: 11px;
}

/* Icons */
.icon {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
}

.btn-icon .icon {
  width: 16px;
  height: 16px;
}

/* Modal */
.modal {
  border: none;
  border-radius: 12px;
  padding: 0;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.modal::backdrop {
  background: rgba(0, 0, 0, 0.5);
}

.modal-content {
  padding: var(--space-5);
}

.modal-content h3 {
  font-family: var(--font-heading);
  font-size: 18px;
  margin-bottom: var(--space-2);
}

.modal-content input,
.modal-content select {
  width: 100%;
  height: 40px;
  padding: 0 var(--space-3);
  border: 1px solid var(--color-border);
  border-radius: 6px;
  font-size: 14px;
  font-family: var(--font-mono);
  margin-top: var(--space-3);
}

.modal-content input:focus,
.modal-content select:focus {
  outline: none;
  border-color: var(--color-primary);
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: var(--space-2);
  margin-top: var(--space-4);
}

.setting-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: var(--space-3);
}

.setting-row label {
  font-weight: 500;
}

.setting-row select {
  width: auto;
  margin: 0;
}

/* Utility */
.text-muted {
  color: var(--color-text-muted);
  font-size: 13px;
}

/* Loading indicator */
.loading {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  color: var(--color-text-muted);
  font-size: 13px;
}

.loading::before {
  content: '';
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--color-primary);
  animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 1; }
}

/* API key indicator */
#api-key-btn.has-key .icon {
  color: #10B981;
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--color-border);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--color-text-muted);
}
  </style>
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="13.5" cy="6.5" r="2.5"/>
          <circle cx="19" cy="17" r="2"/>
          <circle cx="6" cy="18" r="3"/>
          <path d="M12 9v6"/>
          <path d="M9.5 16.5L6 18"/>
          <path d="M14.5 9L18 15"/>
        </svg>
        <h1>go/robo-design</h1>
      </div>
      <div class="header-right">
        <button id="github-btn" class="btn btn-icon" title="GitHub">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2>Themes</h2>
          <button id="new-theme-btn" class="btn btn-icon" title="New Theme">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
          </button>
        </div>
        <div class="sidebar-search">
          <input type="search" id="theme-search" placeholder="Search themes...">
        </div>
        <div class="theme-list" id="theme-list">
          <!-- Themes populated by JS -->
        </div>
      </aside>

      <!-- Resize Handle -->
      <div class="resize-handle" id="sidebar-resize"></div>

      <!-- Center Panel -->
      <div class="center-panel">
        <!-- Preview -->
        <div class="preview-panel" id="preview-panel">
          <div class="preview-toolbar">
            <div class="preview-tabs">
              <button class="tab active" data-preview="buttons">Buttons</button>
              <button class="tab" data-preview="inputs">Inputs</button>
              <button class="tab" data-preview="cards">Cards</button>
              <button class="tab" data-preview="typography">Typography</button>
            </div>
            <div class="viewport-buttons">
              <button class="btn btn-icon active" data-viewport="desktop" title="Desktop">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="3" width="20" height="14" rx="2"/>
                  <line x1="8" y1="21" x2="16" y2="21"/>
                  <line x1="12" y1="17" x2="12" y2="21"/>
                </svg>
              </button>
              <button class="btn btn-icon" data-viewport="tablet" title="Tablet">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="4" y="2" width="16" height="20" rx="2"/>
                  <line x1="12" y1="18" x2="12" y2="18"/>
                </svg>
              </button>
              <button class="btn btn-icon" data-viewport="mobile" title="Mobile">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="5" y="2" width="14" height="20" rx="2"/>
                  <line x1="12" y1="18" x2="12" y2="18"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="preview-frame-wrapper">
            <iframe id="preview-frame" sandbox="allow-scripts"></iframe>
          </div>
        </div>
      </div>

      <!-- Resize Handle -->
      <div class="resize-handle" id="chat-resize"></div>

      <!-- Chat Panel -->
      <aside class="chat-panel" id="chat-panel">
        <div class="chat-header">
          <h2>Claude Assistant</h2>
          <div class="chat-actions">
            <button id="api-key-btn" class="btn btn-icon" title="API Key">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
              </svg>
            </button>
            <button id="clear-chat-btn" class="btn btn-icon" title="Clear Chat">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3,6 5,6 21,6"/>
                <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6M8,6V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="chat-messages" id="chat-messages">
          <div class="chat-empty" id="chat-empty">
            <p>Start a conversation with Claude</p>
            <p class="text-muted">Share screenshots, paste URLs, or ask for design help.</p>
          </div>
        </div>
        <div class="chat-input-area">
          <div class="attachments" id="attachments"></div>
          <div class="chat-input-wrapper">
            <textarea id="chat-input" placeholder="Ask Claude about your design system..." rows="3"></textarea>
            <div class="chat-input-actions">
              <button id="attach-image-btn" class="btn btn-icon" title="Attach Image">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <path d="M21 15l-5-5L5 21"/>
                </svg>
              </button>
              <button id="attach-url-btn" class="btn btn-icon" title="Add URL">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
              </button>
            </div>
          </div>
          <button id="send-btn" class="btn btn-primary">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22,2 15,22 11,13 2,9"/>
            </svg>
            Send
          </button>
        </div>
      </aside>
    </main>
  </div>

  <!-- API Key Modal -->
  <dialog id="api-key-modal" class="modal">
    <div class="modal-content">
      <h3>Anthropic API Key</h3>
      <p class="text-muted">Your key is stored locally in your browser.</p>
      <input type="password" id="api-key-input" placeholder="sk-ant-...">
      <div class="modal-actions">
        <button id="api-key-clear" class="btn btn-secondary">Remove Key</button>
        <button id="api-key-save" class="btn btn-primary">Save</button>
      </div>
    </div>
  </dialog>

  <!-- Hidden file input -->
  <input type="file" id="file-input" accept="image/*" multiple hidden>

  <!-- App Scripts -->
  <script>
// Theme Store - Manages design system themes

const DEFAULT_THEMES = [
  {
    id: 'zed-minimal',
    name: 'Zed Minimal',
    description: 'Clean, minimalist design with blue accent',
    tokens: {
      colors: {
        primary: '#0751CF',
        primaryHover: '#094ACE',
        secondary: '#6B7280',
        text: '#4C5461',
        textSecondary: '#9CA3AF',
        background: '#FAF9F7',
        surface: '#FFFFFF',
        border: '#DEDDD9',
        borderLight: '#F3F2EE',
        focus: 'rgba(9, 78, 206, 0.5)',
        error: '#EF4444',
        warning: '#F59E0B',
        success: '#10B981',
        info: '#3B82F6'
      },
      typography: {
        fontFamilies: {
          heading: 'Lora, Georgia, serif',
          body: 'system-ui, -apple-system, BlinkMacSystemFont, sans-serif',
          mono: 'SF Mono, Monaco, Cascadia Code, Consolas, monospace'
        },
        fontSizes: {
          xs: '12px', sm: '14px', base: '16px', lg: '18px', xl: '20px', '2xl': '24px', '3xl': '30px'
        }
      },
      spacing: { '1': '4px', '2': '8px', '3': '12px', '4': '16px', '5': '24px', '6': '32px', '8': '48px' },
      borderRadius: { none: '0', sm: '2px', md: '4px', lg: '8px', full: '9999px' },
      shadows: { sm: '0 1px 2px rgba(0, 0, 0, 0.05)', md: '0 4px 6px rgba(0, 0, 0, 0.1)', lg: '0 10px 15px rgba(0, 0, 0, 0.1)' }
    }
  },
  {
    id: 'ant-farm',
    name: 'Ant Farm',
    description: 'Warm corporate design with coral accent',
    tokens: {
      colors: {
        primary: '#D4674A',
        primaryHover: '#C25A3E',
        secondary: '#A78BFA',
        text: '#1A1A1A',
        textSecondary: '#6B7280',
        background: '#FFFFFF',
        surface: '#F9FAFB',
        border: '#E5E7EB',
        borderLight: '#F3F4F6',
        focus: 'rgba(212, 103, 74, 0.4)',
        error: '#DC2626',
        warning: '#D97706',
        success: '#059669',
        info: '#2563EB'
      },
      typography: {
        fontFamilies: {
          heading: 'system-ui, -apple-system, BlinkMacSystemFont, sans-serif',
          body: 'system-ui, -apple-system, BlinkMacSystemFont, sans-serif',
          mono: 'SF Mono, Monaco, Consolas, monospace'
        },
        fontSizes: {
          xs: '12px', sm: '14px', base: '16px', lg: '18px', xl: '20px', '2xl': '24px', '3xl': '32px'
        }
      },
      spacing: { '1': '4px', '2': '8px', '3': '12px', '4': '16px', '5': '24px', '6': '32px', '8': '48px' },
      borderRadius: { none: '0', sm: '4px', md: '8px', lg: '12px', full: '9999px' },
      shadows: { sm: '0 1px 3px rgba(0, 0, 0, 0.08)', md: '0 4px 8px rgba(0, 0, 0, 0.12)', lg: '0 12px 24px rgba(0, 0, 0, 0.15)' }
    }
  },
  {
    id: 'dark-mode',
    name: 'Dark Mode',
    description: 'Dark theme with blue accent',
    tokens: {
      colors: {
        primary: '#3B82F6',
        primaryHover: '#2563EB',
        secondary: '#6B7280',
        text: '#F3F4F6',
        textSecondary: '#9CA3AF',
        background: '#111827',
        surface: '#1F2937',
        border: '#374151',
        borderLight: '#4B5563',
        focus: 'rgba(59, 130, 246, 0.5)',
        error: '#F87171',
        warning: '#FBBF24',
        success: '#34D399',
        info: '#60A5FA'
      },
      typography: {
        fontFamilies: {
          heading: 'system-ui, -apple-system, BlinkMacSystemFont, sans-serif',
          body: 'system-ui, -apple-system, BlinkMacSystemFont, sans-serif',
          mono: 'SF Mono, Monaco, Cascadia Code, Consolas, monospace'
        },
        fontSizes: {
          xs: '12px', sm: '14px', base: '16px', lg: '18px', xl: '20px', '2xl': '24px', '3xl': '30px'
        }
      },
      spacing: { '1': '4px', '2': '8px', '3': '12px', '4': '16px', '5': '24px', '6': '32px', '8': '48px' },
      borderRadius: { none: '0', sm: '2px', md: '4px', lg: '8px', full: '9999px' },
      shadows: { sm: '0 1px 2px rgba(0, 0, 0, 0.3)', md: '0 4px 6px rgba(0, 0, 0, 0.4)', lg: '0 10px 15px rgba(0, 0, 0, 0.5)' }
    }
  }
];

const ThemeStore = {
  STORAGE_KEY: 'design-studio:themes',

  defaultTokens: {
    colors: {
      primary: '#0751CF',
      primaryHover: '#0642A8',
      secondary: '#6B7280',
      text: '#4C5461',
      textSecondary: '#9CA3AF',
      background: '#FAF9F7',
      surface: '#FFFFFF',
      border: '#DEDDD8',
      borderLight: '#F3F2EE',
      focus: 'rgba(9, 78, 206, 0.5)',
      error: '#EF4444',
      warning: '#F59E0B',
      success: '#10B981',
      info: '#3B82F6'
    },
    typography: {
      fontFamilies: {
        heading: 'Lora, Georgia, serif',
        body: 'system-ui, -apple-system, BlinkMacSystemFont, sans-serif',
        mono: 'SF Mono, Monaco, Cascadia Code, Consolas, monospace'
      },
      fontSizes: {
        xs: '12px',
        sm: '14px',
        base: '16px',
        lg: '18px',
        xl: '20px',
        '2xl': '24px',
        '3xl': '30px'
      }
    },
    spacing: {
      '1': '4px',
      '2': '8px',
      '3': '12px',
      '4': '16px',
      '5': '24px',
      '6': '32px',
      '8': '48px'
    },
    borderRadius: {
      none: '0',
      sm: '2px',
      md: '4px',
      lg: '8px',
      full: '9999px'
    },
    shadows: {
      sm: '0 1px 2px rgba(0, 0, 0, 0.05)',
      md: '0 4px 6px rgba(0, 0, 0, 0.1)',
      lg: '0 10px 15px rgba(0, 0, 0, 0.1)'
    }
  },

  themes: [],
  activeThemeId: null,
  listeners: [],

  init() {
    console.log('[ThemeStore] Initializing...');
    this.load();
    console.log('[ThemeStore] Loaded themes:', this.themes.length);

    // Always ensure default themes exist
    const defaultIds = DEFAULT_THEMES.map(t => t.id);
    const hasAllDefaults = defaultIds.every(id => this.themes.some(t => t.id === id));
    console.log('[ThemeStore] Has all defaults:', hasAllDefaults);

    if (!hasAllDefaults) {
      console.log('[ThemeStore] Adding default themes...');
      // Add missing default themes
      const now = new Date().toISOString();
      for (const defaultTheme of DEFAULT_THEMES) {
        if (!this.themes.some(t => t.id === defaultTheme.id)) {
          this.themes.unshift({
            ...defaultTheme,
            createdAt: now,
            updatedAt: now,
            cssVariables: this.generateCssVariables(defaultTheme.tokens),
            componentStyles: this.generateComponentStyles(),
            version: 1
          });
        }
      }
      // Set active theme if none selected
      if (!this.activeThemeId || !this.themes.some(t => t.id === this.activeThemeId)) {
        this.activeThemeId = this.themes[0].id;
      }
      this.save();
      console.log('[ThemeStore] Saved', this.themes.length, 'themes');
    }

    console.log('[ThemeStore] Final state:', this.themes.length, 'themes, active:', this.activeThemeId);
    this.notify();
  },

  load() {
    try {
      const data = localStorage.getItem(this.STORAGE_KEY);
      if (data) {
        const parsed = JSON.parse(data);
        this.themes = parsed.themes || [];
        this.activeThemeId = parsed.activeThemeId;
      }
    } catch (e) {
      console.error('Failed to load themes:', e);
    }
  },

  save() {
    try {
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify({
        themes: this.themes,
        activeThemeId: this.activeThemeId
      }));
    } catch (e) {
      console.error('Failed to save themes:', e);
    }
  },

  subscribe(listener) {
    this.listeners.push(listener);
    return () => {
      this.listeners = this.listeners.filter(l => l !== listener);
    };
  },

  notify() {
    this.listeners.forEach(l => l(this.getState()));
  },

  getState() {
    return {
      themes: this.themes,
      activeTheme: this.getActiveTheme(),
      activeThemeId: this.activeThemeId
    };
  },

  getActiveTheme() {
    return this.themes.find(t => t.id === this.activeThemeId) || null;
  },

  generateId() {
    return 'theme-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9);
  },

  createTheme(name, description = '') {
    const now = new Date().toISOString();
    const tokens = JSON.parse(JSON.stringify(this.defaultTokens));

    const theme = {
      id: this.generateId(),
      name,
      description,
      createdAt: now,
      updatedAt: now,
      tokens,
      cssVariables: this.generateCssVariables(tokens),
      componentStyles: this.generateComponentStyles(),
      version: 1
    };

    this.themes.push(theme);
    this.activeThemeId = theme.id;
    this.save();
    this.notify();
    return theme;
  },

  updateTheme(id, updates) {
    const index = this.themes.findIndex(t => t.id === id);
    if (index === -1) return;

    const theme = this.themes[index];
    Object.assign(theme, updates);
    theme.updatedAt = new Date().toISOString();
    theme.version += 1;

    // Regenerate CSS if tokens changed
    if (updates.tokens) {
      theme.cssVariables = this.generateCssVariables(theme.tokens);
    }

    this.save();
    this.notify();
  },

  setActiveTheme(id) {
    this.activeThemeId = id;
    this.save();
    this.notify();
  },

  deleteTheme(id) {
    this.themes = this.themes.filter(t => t.id !== id);
    if (this.activeThemeId === id) {
      this.activeThemeId = this.themes[0]?.id || null;
    }
    this.save();
    this.notify();
  },

  duplicateTheme(id, newName) {
    const original = this.themes.find(t => t.id === id);
    if (!original) return null;

    const theme = this.createTheme(newName, original.description);
    theme.tokens = JSON.parse(JSON.stringify(original.tokens));
    theme.cssVariables = original.cssVariables;
    theme.componentStyles = original.componentStyles;
    this.save();
    this.notify();
    return theme;
  },

  generateCssVariables(tokens) {
    const lines = [':root {'];

    // Colors
    Object.entries(tokens.colors).forEach(([key, value]) => {
      const kebab = key.replace(/([A-Z])/g, '-$1').toLowerCase();
      lines.push(`  --color-${kebab}: ${value};`);
    });

    // Typography
    Object.entries(tokens.typography.fontFamilies).forEach(([key, value]) => {
      lines.push(`  --font-${key}: ${value};`);
    });
    Object.entries(tokens.typography.fontSizes).forEach(([key, value]) => {
      lines.push(`  --text-${key}: ${value};`);
    });

    // Spacing
    Object.entries(tokens.spacing).forEach(([key, value]) => {
      lines.push(`  --space-${key}: ${value};`);
    });

    // Border radius
    Object.entries(tokens.borderRadius).forEach(([key, value]) => {
      lines.push(`  --radius-${key}: ${value};`);
    });

    // Shadows
    Object.entries(tokens.shadows).forEach(([key, value]) => {
      lines.push(`  --shadow-${key}: ${value};`);
    });

    lines.push('}');
    return lines.join('\n');
  },

  generateComponentStyles() {
    return `/* Component Styles */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-2) var(--space-4);
  font-size: var(--text-sm);
  font-weight: 500;
  border-radius: var(--radius-md);
  transition: all 0.1s ease;
  cursor: pointer;
  border: none;
}

.btn-primary {
  background-color: var(--color-primary);
  color: white;
}

.btn-primary:hover {
  background-color: var(--color-primary-hover);
}

.btn-secondary {
  background-color: transparent;
  color: var(--color-text);
  border: 1px solid var(--color-border);
}

.btn-secondary:hover {
  background-color: var(--color-background);
}

.input {
  height: 36px;
  padding: 0 var(--space-3);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  font-size: var(--text-sm);
  background-color: var(--color-surface);
  transition: border-color 0.1s ease;
}

.input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px var(--color-focus);
}

.card {
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-4);
  box-shadow: var(--shadow-sm);
}`;
  }
};

// Claude API Integration

const ClaudeAPI = {
  STORAGE_KEY: 'design-studio:api-key',
  MESSAGES_KEY: 'design-studio:messages',

  apiKey: null,
  messages: [],
  isLoading: false,
  listeners: [],

  SYSTEM_PROMPT: `You are a design system expert helping users create and refine UI themes.
You have access to the current design system files and can suggest changes.

When suggesting changes, format your response as follows:

1. Explain what you're changing and why
2. Provide the updated code in a code block with the filename:

\`\`\`css filename="variables.css"
:root {
  --color-primary: #0751CF;
  ...
}
\`\`\`

When analyzing screenshots or URLs:
- Identify color palettes, typography, spacing patterns
- Suggest matching design tokens
- Reference specific visual elements from the image

Always maintain consistency with existing design tokens.`,

  init() {
    this.apiKey = localStorage.getItem(this.STORAGE_KEY);
    try {
      const saved = localStorage.getItem(this.MESSAGES_KEY);
      if (saved) {
        this.messages = JSON.parse(saved);
      }
    } catch (e) {
      console.error('Failed to load messages:', e);
    }
    this.notify();
  },

  subscribe(listener) {
    this.listeners.push(listener);
    return () => {
      this.listeners = this.listeners.filter(l => l !== listener);
    };
  },

  notify() {
    this.listeners.forEach(l => l(this.getState()));
  },

  getState() {
    return {
      apiKey: this.apiKey,
      messages: this.messages,
      isLoading: this.isLoading,
      hasApiKey: !!this.apiKey
    };
  },

  setApiKey(key) {
    this.apiKey = key;
    if (key) {
      localStorage.setItem(this.STORAGE_KEY, key);
    } else {
      localStorage.removeItem(this.STORAGE_KEY);
    }
    this.notify();
  },

  clearMessages() {
    this.messages = [];
    localStorage.removeItem(this.MESSAGES_KEY);
    this.notify();
  },

  saveMessages() {
    try {
      localStorage.setItem(this.MESSAGES_KEY, JSON.stringify(this.messages));
    } catch (e) {
      console.error('Failed to save messages:', e);
    }
  },

  generateId() {
    return 'msg-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9);
  },

  parseChangeSuggestions(response) {
    const codeBlockRegex = /```(\w+)\s+filename="([^"]+)"\n([\s\S]*?)```/g;
    const suggestions = [];

    let match;
    while ((match = codeBlockRegex.exec(response)) !== null) {
      suggestions.push({
        id: this.generateId(),
        language: match[1],
        filename: match[2],
        content: match[3].trim(),
        applied: false
      });
    }

    return suggestions;
  },

  async sendMessage(text, attachments = []) {
    if (!this.apiKey) {
      throw new Error('API key not set');
    }

    // Build user message content
    const content = [];

    // Add images first
    for (const attachment of attachments) {
      if (attachment.type === 'image') {
        content.push({
          type: 'image',
          source: {
            type: 'base64',
            media_type: attachment.mediaType,
            data: attachment.data
          }
        });
      } else if (attachment.type === 'url') {
        // Add URL as text
        text = `[Analyzing URL: ${attachment.data}]\n\n${text}`;
      }
    }

    content.push({ type: 'text', text });

    // Create user message
    const userMessage = {
      id: this.generateId(),
      role: 'user',
      content,
      timestamp: new Date().toISOString()
    };

    this.messages.push(userMessage);
    this.isLoading = true;
    this.notify();

    try {
      // Build context from active theme
      const activeTheme = ThemeStore.getActiveTheme();
      let contextString = '';
      if (activeTheme) {
        contextString = `
--- tokens.json ---
${JSON.stringify(activeTheme.tokens, null, 2)}

--- variables.css ---
${activeTheme.cssVariables}

--- components.css ---
${activeTheme.componentStyles}`;
      }

      // Build API messages
      const apiMessages = this.messages.map(m => ({
        role: m.role,
        content: m.content
      }));

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': this.apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514', // Claude Sonnet 4 - fast and capable for design tasks
          max_tokens: 4096,
          system: `${this.SYSTEM_PROMPT}\n\nCURRENT DESIGN SYSTEM CONTEXT:\n${contextString}`,
          messages: apiMessages
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error?.message || 'API request failed');
      }

      const data = await response.json();
      const assistantText = data.content[0].text;

      // Parse suggestions
      const suggestions = this.parseChangeSuggestions(assistantText);

      const assistantMessage = {
        id: this.generateId(),
        role: 'assistant',
        content: [{ type: 'text', text: assistantText }],
        timestamp: new Date().toISOString(),
        suggestions: suggestions.length > 0 ? suggestions : undefined
      };

      this.messages.push(assistantMessage);
      this.saveMessages();

    } catch (error) {
      // Add error message
      this.messages.push({
        id: this.generateId(),
        role: 'assistant',
        content: [{ type: 'text', text: `Error: ${error.message}` }],
        timestamp: new Date().toISOString(),
        isError: true
      });
    } finally {
      this.isLoading = false;
      this.notify();
    }
  },

  applySuggestion(messageId, suggestionId) {
    const message = this.messages.find(m => m.id === messageId);
    if (!message?.suggestions) return;

    const suggestion = message.suggestions.find(s => s.id === suggestionId);
    if (!suggestion) return;

    const activeTheme = ThemeStore.getActiveTheme();
    if (!activeTheme) return;

    // Apply based on filename
    if (suggestion.filename === 'variables.css') {
      ThemeStore.updateTheme(activeTheme.id, { cssVariables: suggestion.content });
    } else if (suggestion.filename === 'components.css') {
      ThemeStore.updateTheme(activeTheme.id, { componentStyles: suggestion.content });
    } else if (suggestion.filename === 'tokens.json') {
      try {
        const tokens = JSON.parse(suggestion.content);
        ThemeStore.updateTheme(activeTheme.id, { tokens });
      } catch (e) {
        console.error('Invalid JSON in suggestion:', e);
      }
    }

    suggestion.applied = true;
    this.saveMessages();
    this.notify();
  }
};

// Preview Panel Manager

const PreviewManager = {
  currentCategory: 'buttons',
  currentViewport: 'desktop',
  frame: null,

  viewportWidths: {
    desktop: '100%',
    tablet: '768px',
    mobile: '375px'
  },

  init() {
    this.frame = document.getElementById('preview-frame');

    // Subscribe to theme changes
    ThemeStore.subscribe(() => {
      this.updatePreview();
    });

    this.updatePreview();
  },

  setCategory(category) {
    this.currentCategory = category;
    this.updatePreview();
  },

  setViewport(viewport) {
    this.currentViewport = viewport;
    this.frame.style.width = this.viewportWidths[viewport];
  },

  updatePreview() {
    const theme = ThemeStore.getActiveTheme();
    const html = this.generatePreviewHtml(
      this.currentCategory,
      theme?.cssVariables || '',
      theme?.componentStyles || ''
    );
    this.frame.srcdoc = html;
  },

  generatePreviewHtml(category, cssVariables, componentStyles) {
    const styles = `
      ${cssVariables}
      ${componentStyles}
      body {
        font-family: var(--font-body, system-ui, sans-serif);
        padding: 24px;
        background: var(--color-background, #FAF9F7);
        color: var(--color-text, #4C5461);
        margin: 0;
      }
      .preview-section {
        margin-bottom: 24px;
      }
      .preview-section h3 {
        font-family: var(--font-heading, Georgia, serif);
        font-size: var(--text-lg, 18px);
        margin: 0 0 12px 0;
      }
      .preview-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
    `;

    const content = this.getCategoryContent(category);

    return `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&display=swap" rel="stylesheet">
          <style>${styles}</style>
        </head>
        <body>${content}</body>
      </html>
    `;
  },

  getCategoryContent(category) {
    switch (category) {
      case 'buttons':
        return `
          <div class="preview-section">
            <h3>Primary Buttons</h3>
            <div class="preview-row">
              <button class="btn btn-primary">Primary</button>
              <button class="btn btn-primary" disabled>Disabled</button>
            </div>
          </div>
          <div class="preview-section">
            <h3>Secondary Buttons</h3>
            <div class="preview-row">
              <button class="btn btn-secondary">Secondary</button>
              <button class="btn btn-secondary" disabled>Disabled</button>
            </div>
          </div>
        `;

      case 'inputs':
        return `
          <div class="preview-section">
            <h3>Text Inputs</h3>
            <div class="preview-row">
              <input type="text" class="input" placeholder="Enter text..." />
              <input type="text" class="input" value="With value" />
            </div>
          </div>
          <div class="preview-section">
            <h3>Search Input</h3>
            <div class="preview-row">
              <input type="search" class="input" placeholder="Search..." style="width: 250px" />
            </div>
          </div>
        `;

      case 'cards':
        return `
          <div class="preview-section">
            <h3>Cards</h3>
            <div class="preview-row">
              <div class="card" style="width: 280px">
                <h4 style="margin: 0 0 8px 0; font-family: var(--font-heading);">Card Title</h4>
                <p style="margin: 0; font-size: var(--text-sm);">This is a card component with some example content.</p>
              </div>
              <div class="card" style="width: 280px">
                <h4 style="margin: 0 0 8px 0; font-family: var(--font-heading);">Another Card</h4>
                <p style="margin: 0; font-size: var(--text-sm);">Cards can contain various types of content.</p>
              </div>
            </div>
          </div>
        `;

      case 'typography':
        return `
          <div class="preview-section">
            <h1 style="font-family: var(--font-heading); font-size: var(--text-3xl); margin: 0 0 8px 0;">Heading 1</h1>
            <h2 style="font-family: var(--font-heading); font-size: var(--text-2xl); margin: 0 0 8px 0;">Heading 2</h2>
            <h3 style="font-family: var(--font-heading); font-size: var(--text-xl); margin: 0 0 8px 0;">Heading 3</h3>
            <p style="font-size: var(--text-base); margin: 16px 0;">Body text in the base size. This is how regular paragraph text will appear in your design system.</p>
            <p style="font-size: var(--text-sm); color: var(--color-text-secondary);">Small text for captions and secondary information.</p>
            <p style="margin-top: 16px;">
              <code style="font-family: var(--font-mono); background: var(--color-border-light); padding: 2px 6px; border-radius: 4px;">code example</code>
            </p>
          </div>
        `;

      default:
        return '<p>Select a category</p>';
    }
  }
};

// Main Application

const App = {
  attachments: [],

  async init() {
    console.log('[App] Initializing...');

    // Initialize stores
    ThemeStore.init();
    ClaudeAPI.init();

    // Initialize preview
    PreviewManager.init();
    console.log('[App] All modules initialized');

    // Set up UI event listeners
    this.setupEventListeners();

    // Subscribe to state changes
    ThemeStore.subscribe(state => this.renderThemeList(state));
    ClaudeAPI.subscribe(state => this.renderChat(state));

    // Initial render
    this.renderThemeList(ThemeStore.getState());
    this.renderChat(ClaudeAPI.getState());
  },

  setupEventListeners() {
    // Theme list
    document.getElementById('new-theme-btn').addEventListener('click', () => {
      const name = prompt('Theme name:', 'New Theme');
      if (name) {
        ThemeStore.createTheme(name);
      }
    });

    document.getElementById('theme-search').addEventListener('input', (e) => {
      this.filterThemes(e.target.value);
    });

    // Preview tabs
    document.querySelectorAll('.preview-tabs .tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.preview-tabs .tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        PreviewManager.setCategory(tab.dataset.preview);
      });
    });

    // Viewport buttons
    document.querySelectorAll('.viewport-buttons .btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.viewport-buttons .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        PreviewManager.setViewport(btn.dataset.viewport);
      });
    });

    // API Key modal
    document.getElementById('api-key-btn').addEventListener('click', () => {
      document.getElementById('api-key-modal').showModal();
    });

    document.getElementById('api-key-save').addEventListener('click', () => {
      const key = document.getElementById('api-key-input').value.trim();
      if (key) {
        ClaudeAPI.setApiKey(key);
        document.getElementById('api-key-input').value = '';
        document.getElementById('api-key-modal').close();
      }
    });

    document.getElementById('api-key-clear').addEventListener('click', () => {
      ClaudeAPI.setApiKey(null);
      document.getElementById('api-key-modal').close();
    });

    // Chat
    document.getElementById('clear-chat-btn').addEventListener('click', () => {
      if (confirm('Clear all messages?')) {
        ClaudeAPI.clearMessages();
      }
    });

    document.getElementById('send-btn').addEventListener('click', () => {
      this.sendMessage();
    });

    document.getElementById('chat-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        this.sendMessage();
      }
    });

    // Image paste
    document.getElementById('chat-input').addEventListener('paste', (e) => {
      const items = e.clipboardData.items;
      for (const item of items) {
        if (item.type.startsWith('image/')) {
          e.preventDefault();
          const file = item.getAsFile();
          this.processImageFile(file);
          break;
        }
      }
    });

    // File input
    document.getElementById('attach-image-btn').addEventListener('click', () => {
      document.getElementById('file-input').click();
    });

    document.getElementById('file-input').addEventListener('change', (e) => {
      for (const file of e.target.files) {
        if (file.type.startsWith('image/')) {
          this.processImageFile(file);
        }
      }
      e.target.value = '';
    });

    // URL attachment
    document.getElementById('attach-url-btn').addEventListener('click', () => {
      const url = prompt('Enter URL:');
      if (url) {
        this.attachments.push({ type: 'url', data: url });
        this.renderAttachments();
      }
    });

    // Drag and drop
    const chatInput = document.getElementById('chat-input');
    chatInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      chatInput.style.borderColor = 'var(--color-primary)';
    });

    chatInput.addEventListener('dragleave', () => {
      chatInput.style.borderColor = '';
    });

    chatInput.addEventListener('drop', (e) => {
      e.preventDefault();
      chatInput.style.borderColor = '';
      for (const file of e.dataTransfer.files) {
        if (file.type.startsWith('image/')) {
          this.processImageFile(file);
        }
      }
    });

    // Resize handles
    this.setupResizeHandles();

    // Modal close on backdrop click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.close();
        }
      });
    });
  },

  setupResizeHandles() {
    const sidebar = document.getElementById('sidebar');
    const chatPanel = document.getElementById('chat-panel');

    // Sidebar resize
    this.makeResizable(
      document.getElementById('sidebar-resize'),
      (delta) => {
        const newWidth = sidebar.offsetWidth + delta;
        if (newWidth >= 150 && newWidth <= 350) {
          sidebar.style.width = newWidth + 'px';
        }
      }
    );

    // Chat resize
    this.makeResizable(
      document.getElementById('chat-resize'),
      (delta) => {
        const newWidth = chatPanel.offsetWidth - delta;
        if (newWidth >= 250 && newWidth <= 500) {
          chatPanel.style.width = newWidth + 'px';
        }
      }
    );
  },

  makeResizable(handle, onResize, vertical = false) {
    let startPos = 0;

    const onMouseDown = (e) => {
      startPos = vertical ? e.clientY : e.clientX;
      handle.classList.add('active');
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      document.body.style.cursor = vertical ? 'row-resize' : 'col-resize';
      document.body.style.userSelect = 'none';
    };

    const onMouseMove = (e) => {
      const currentPos = vertical ? e.clientY : e.clientX;
      const delta = currentPos - startPos;
      startPos = currentPos;
      onResize(delta);
    };

    const onMouseUp = () => {
      handle.classList.remove('active');
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    };

    handle.addEventListener('mousedown', onMouseDown);
  },

  processImageFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const base64 = e.target.result.split(',')[1];
      this.attachments.push({
        type: 'image',
        data: base64,
        mediaType: file.type,
        preview: e.target.result
      });
      this.renderAttachments();
    };
    reader.readAsDataURL(file);
  },

  renderAttachments() {
    const container = document.getElementById('attachments');
    container.innerHTML = this.attachments.map((att, i) => {
      if (att.type === 'image') {
        return `
          <div class="attachment">
            <img src="${att.preview}" alt="Attachment">
            <button class="attachment-remove" data-index="${i}">&times;</button>
          </div>
        `;
      } else {
        return `
          <div class="attachment">
            <div style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: var(--color-border-light); border-radius: 6px; font-size: 10px; overflow: hidden; padding: 4px;">
              ${att.data.slice(0, 20)}...
            </div>
            <button class="attachment-remove" data-index="${i}">&times;</button>
          </div>
        `;
      }
    }).join('');

    // Add remove handlers
    container.querySelectorAll('.attachment-remove').forEach(btn => {
      btn.addEventListener('click', () => {
        this.attachments.splice(parseInt(btn.dataset.index), 1);
        this.renderAttachments();
      });
    });
  },

  async sendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();

    if (!text && this.attachments.length === 0) return;
    if (!ClaudeAPI.apiKey) {
      alert('Please set your API key first');
      return;
    }
    if (ClaudeAPI.isLoading) return;

    input.value = '';
    const attachments = [...this.attachments];
    this.attachments = [];
    this.renderAttachments();

    await ClaudeAPI.sendMessage(text, attachments);
  },

  renderThemeList(state) {
    const container = document.getElementById('theme-list');
    const searchTerm = document.getElementById('theme-search').value.toLowerCase();

    const filteredThemes = state.themes.filter(theme =>
      theme.name.toLowerCase().includes(searchTerm) ||
      (theme.description && theme.description.toLowerCase().includes(searchTerm))
    );

    container.innerHTML = filteredThemes.map(theme => `
      <button class="theme-item ${theme.id === state.activeThemeId ? 'active' : ''}" data-id="${theme.id}">
        <div class="theme-item-name">${this.escapeHtml(theme.name)}</div>
        ${theme.description ? `<div class="theme-item-desc">${this.escapeHtml(theme.description)}</div>` : ''}
      </button>
    `).join('');

    // Add click handlers
    container.querySelectorAll('.theme-item').forEach(item => {
      item.addEventListener('click', () => {
        ThemeStore.setActiveTheme(item.dataset.id);
      });
    });
  },

  filterThemes(searchTerm) {
    this.renderThemeList(ThemeStore.getState());
  },

  renderChat(state) {
    const messagesContainer = document.getElementById('chat-messages');
    const emptyState = document.getElementById('chat-empty');
    const apiKeyBtn = document.getElementById('api-key-btn');

    // Update API key button
    if (state.hasApiKey) {
      apiKeyBtn.classList.add('has-key');
    } else {
      apiKeyBtn.classList.remove('has-key');
    }

    // Show/hide empty state
    if (state.messages.length === 0) {
      emptyState.style.display = 'block';
      if (!state.hasApiKey) {
        emptyState.innerHTML = `
          <div style="padding: 32px 16px; text-align: center;">
            <div style="width: 64px; height: 64px; margin: 0 auto 16px; background: var(--color-border-light); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="2">
                <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
              </svg>
            </div>
            <h3 style="margin: 0 0 8px; font-size: 18px;">Connect to Claude</h3>
            <p style="color: var(--color-text-muted); margin: 0 0 20px; font-size: 14px;">Add your Anthropic API key to chat with Claude about your designs.</p>
            <button id="setup-api-key-btn" class="btn btn-primary" style="width: 100%;">
              Set Up API Key
            </button>
            <p style="color: var(--color-text-muted); margin: 16px 0 0; font-size: 12px;">
              Get a key at <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: var(--color-primary);">console.anthropic.com</a>
            </p>
          </div>
        `;
        // Add click handler for setup button
        document.getElementById('setup-api-key-btn')?.addEventListener('click', () => {
          document.getElementById('api-key-modal').showModal();
        });
      } else {
        emptyState.innerHTML = `
          <p>Start a conversation with Claude</p>
          <p class="text-muted">Share screenshots, paste URLs, or ask for design help.</p>
        `;
      }
      return;
    }

    emptyState.style.display = 'none';

    // Render messages
    let html = state.messages.map(msg => this.renderMessage(msg)).join('');

    if (state.isLoading) {
      html += '<div class="loading">Claude is thinking...</div>';
    }

    messagesContainer.innerHTML = html;

    // Add suggestion handlers
    messagesContainer.querySelectorAll('.apply-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        ClaudeAPI.applySuggestion(btn.dataset.messageId, btn.dataset.suggestionId);
      });
    });

    messagesContainer.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        await navigator.clipboard.writeText(btn.dataset.content);
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
      });
    });

    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  },

  renderMessage(msg) {
    const isUser = msg.role === 'user';
    const avatarIcon = isUser
      ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'
      : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8V4H8"/><rect x="8" y="8" width="8" height="12" rx="2"/><path d="M12 12h.01"/></svg>';

    let contentHtml = '';
    for (const content of msg.content) {
      if (content.type === 'text') {
        contentHtml += `<div class="chat-bubble">${this.escapeHtml(content.text).replace(/\n/g, '<br>')}</div>`;
      } else if (content.type === 'image') {
        contentHtml += `<img src="data:${content.source.media_type};base64,${content.source.data}" class="chat-image" alt="Shared image">`;
      }
    }

    // Render suggestions
    if (msg.suggestions && msg.suggestions.length > 0) {
      for (const suggestion of msg.suggestions) {
        contentHtml += `
          <div class="suggestion-card">
            <div class="suggestion-header">
              <span>${this.escapeHtml(suggestion.filename)}</span>
              <div class="suggestion-actions">
                <button class="btn btn-sm copy-btn" data-content="${this.escapeHtml(suggestion.content)}">Copy</button>
                <button class="btn btn-sm btn-primary apply-btn" data-message-id="${msg.id}" data-suggestion-id="${suggestion.id}" ${suggestion.applied ? 'disabled' : ''}>
                  ${suggestion.applied ? 'Applied' : 'Apply'}
                </button>
              </div>
            </div>
            <pre class="suggestion-code">${this.escapeHtml(suggestion.content.slice(0, 500))}${suggestion.content.length > 500 ? '...' : ''}</pre>
          </div>
        `;
      }
    }

    return `
      <div class="chat-message ${isUser ? 'user' : 'assistant'}">
        <div class="chat-avatar">
          ${avatarIcon}
        </div>
        <div class="chat-content">
          ${contentHtml}
        </div>
      </div>
    `;
  },

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  App.init();
});
  </script>
</body>
</html>
